name: Testnet Indexing

on:
  push:
    branches:
      - python_toolchain

  pull_request:
    branches:
      - master

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  indexing_test:
    name: Indexing Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45 
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .

      - name: Pull docker containers
        run: tevmc pull --headless

      - name: Config hyperion
        run: |
          tevmc config \
            --hyperion-cfg-path=docker/hyperion/config/chains/telos-testnet.config.json \
            --indexer-start-on=136229794 \
            --index-only-evm 

      - name: Build docker containers
        run: tevmc build --headless

      - name: Pull tevmc up 
        run: |
          tevmc up \
            --loglevel=info \
            --chain-name=telos-testnet \
            --snapshot=/root/snapshots/snapshot-testnet-20211020-blknum-136229794.bin

      - name: Await evm deploy block
        run: tevmc wait-block 136350036
      - name: Await evm deploy transaction indexing
        run: tevmc wait-tx 4a218964eeb3191bd3de0aa9b2bd5758b82b846b5e1084262fe7f2e6c1c3fc01
